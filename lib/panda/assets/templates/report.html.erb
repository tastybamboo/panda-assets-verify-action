<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="UTF-8">

    <title>Panda Assets Report</title>

    <!-- -------------------------------------------------------- -->
    <!-- Tailwind-Lite Variables + Dark Mode -->
    <!-- -------------------------------------------------------- -->
    <style>
    :root {
      --bg: #f8fafc;
      --text: #111827;
      --border: #e5e7eb;
      --panel: #ffffff;
      --panel-alt: #f9fafb;

      --green: #16a34a;
      --red:   #dc2626;
      --yellow:#ca8a04;

      --code-bg: #eef2ff;
      --purple: #7c3aed;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f172a;
        --text: #e2e8f0;
        --border: #334155;
        --panel: #1e293b;
        --panel-alt: #334155;
        --code-bg: #1e293b;
      }
    }

    body.dark {
      --bg: #0f172a;
      --text: #e2e8f0;
      --border: #334155;
      --panel: #1e293b;
      --panel-alt: #334155;
      --code-bg: #1e293b;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0 0 4rem 0;
      line-height: 1.5;
    }

    .container {
      max-width: 960px;
      margin: 2rem auto;
      background: var(--panel);
      padding: 2rem 3rem;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    }

    h1 { font-size: 2rem; margin-bottom: 0.6rem; }
    h2 { font-size: 1.45rem; margin-top: 2rem; margin-bottom: 0.6rem; }
    h3 { font-size: 1.2rem; margin-top: 1.2rem; margin-bottom: 0.4rem; }

    .badge {
      padding: 0.25rem 0.65rem;
      font-size: 0.85rem;
      border-radius: 6px;
      font-weight: 600;
      color: #fff;
    }
    .green  { background: var(--green); }
    .red    { background: var(--red); }
    .yellow { background: var(--yellow); }
    .purple { background: var(--purple); }

    /* Collapsible sections */
    details {
      margin-top: 1rem;
      background: var(--panel-alt);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.5rem;
    }

    /* Code/logs */
    pre, code {
      background: var(--code-bg);
      padding: 0.5rem;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 0.9rem;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.8rem;
    }
    th, td {
      text-align: left;
      padding: 0.6rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    th {
      background: var(--panel-alt);
      font-weight: 600;
    }
    .file-pass { color: var(--green); font-weight: 600; }
    .file-fail { color: var(--red); font-weight: 600; }

    /* Progress bar */
    .progress-bar {
      height: 12px;
      background: var(--border);
      border-radius: 6px;
      margin-top: 6px;
      position: relative;
      overflow: hidden;
    }
    .progress-fill {
      background: var(--green);
      height: 100%;
      width: 0%;
      transition: width 1.2s ease;
    }
    .progress-fill.fail {
      background: var(--red);
    }

    /* Importmap graph */
    .tree {
      border-left: 2px solid var(--border);
      padding-left: 1rem;
      margin-left: 0.5rem;
    }
    .tree-item {
      margin: 0.2rem 0;
    }

    /* Dark mode toggle */
    #theme-toggle {
      cursor: pointer;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      background: var(--panel-alt);
      border: 1px solid var(--border);
      font-size: 0.85rem;
      float: right;
    }

    footer {
      text-align: center;
      opacity: 0.65;
      margin-top: 3rem;
      font-size: 0.85rem;
    }
  </style>

    <script>
    // Dark mode toggle
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('pandaTheme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }
    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem('pandaTheme') === 'dark') document.body.classList.add('dark');

      // Animate progress bars
      document.querySelectorAll(".progress-fill").forEach(bar => {
        const target = bar.dataset.progress;
        setTimeout(() => { bar.style.width = target + "%"; }, 150);
      });
    });
  </script>
  </head>

  <body>
    <div class="container">
      <button id="theme-toggle" onclick="toggleTheme()">üåì Toggle Theme</button>

      <h1>üêº Panda Assets Verification Report</h1>

      <p>
        <strong>Generated:</strong>
        <%= Time.now.strftime("%Y-%m-%d %H:%M:%S %Z") %>
      </p>

      <h2>
        Overall:
        <% if summary.failed? %>
          <span class="badge red">FAIL</span>
        <% else %>
          <span class="badge green">PASS</span>
        <% end %>
      </h2>

      <!-- -------------------------------------------------------------- -->
      <!-- MODULE SUMMARIES (NEW!) -->
      <!-- -------------------------------------------------------------- -->
      <% if summary.respond_to?(:module_summaries) && summary.module_summaries.any? %>
        <h2>Module Summaries</h2>
        <% summary.module_summaries.each do |mod| %>
          <details>
            <summary>
              <strong><%= mod[:name] %></strong> ‚Äî <%= mod[:files].size %>
              files
            </summary>

            <table>
              <thead>
                <tr>
                  <th>File</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <% mod[:files].each do |f| %>
                  <tr>
                    <td><code><%= f[:file] %></code></td>
                    <td>
                      <% if f[:status] == :ok %>
                        <span class="file-pass">‚úì</span>
                      <% else %>
                        <span class="file-fail">‚úó</span>
                      <% end %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </details>
        <% end %>
      <% end %>

      <!-- -------------------------------------------------------------- -->
      <!-- VERSION RESOLUTION (existing) -->
      <!-- -------------------------------------------------------------- -->
      <% if summary.respond_to?(:version_matrix) && summary.version_matrix.any? %>
        <h2>Version Resolution</h2>
        <div class="progress-bar">
          <% pct = summary.version_matrix.count { |r| r[:status] == :ok } * 100 / summary.version_matrix.size %>
          <div
            class="progress-fill <%= pct == 100 ? '' : 'fail' %>"
            data-progress="<%= pct %>"
          ></div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Module</th>
              <th>File</th>
              <th>Path</th>
              <th>Version</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            <% summary.version_matrix.each do |row| %>
              <tr>
                <td><%= row[:module] %></td>
                <td><code><%= row[:file] %></code></td>
                <td><%= row[:path] %></td>
                <td><%= row[:version] || "n/a" %></td>
                <td>
                  <% if row[:status] == :ok %>
                    <span class="file-pass">‚úì OK</span>
                  <% else %>
                    <span class="file-fail">‚úó Missing</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% end %>

      <!-- -------------------------------------------------------------- -->
      <!-- DIFF VIEW: Expected vs Missing -->
      <!-- -------------------------------------------------------------- -->
      <h2>Diff View</h2>

      <% if summary.respond_to?(:diff_missing) && summary.diff_missing.any? %>
        <details open>
          <summary><strong>Missing Assets</strong></summary>
          <ul>
            <% summary.diff_missing.each do |file| %>
              <li>‚ùå <code><%= file %></code></li>
            <% end %>
          </ul>
        </details>
      <% else %>
        <p><span class="badge green">No assets missing</span></p>
      <% end %>

      <!-- -------------------------------------------------------------- -->
      <!-- IMPORTMAP GRAPH (NEW!) -->
      <!-- -------------------------------------------------------------- -->
      <% if summary.respond_to?(:importmap_tree) && summary.importmap_tree.any? %>
        <h2>Importmap Modules</h2>
        <details open>
          <summary>
            <strong>Importmap Graph</strong> (click to collapse)
          </summary>
          <div class="tree">
            <% summary.importmap_tree.each do |pkg, entry| %>
              <div class="tree-item">
                üì¶
                <strong><%= pkg %></strong>
                <div class="tree">
                  <div class="tree-item"><code><%= entry[:path] %></code></div>
                </div>
              </div>
            <% end %>
          </div>
        </details>
      <% end %>

      <!-- -------------------------------------------------------------- -->
      <!-- PREPARE DETAILS -->
      <!-- -------------------------------------------------------------- -->
      <h2>Prepare Phase</h2>

      <% if summary.prepare_ok? %>
        <span class="badge green">Prepare OK</span>
      <% else %>
        <span class="badge red">Prepare Failed</span>
      <% end %>

      <% if summary.prepare_errors.any? %>
        <details open>
          <summary><strong>Errors</strong></summary>
          <ul>
            <% summary.prepare_errors.each do |err| %>
              <li>‚ùå <%= err %></li>
            <% end %>
          </ul>
        </details>
      <% end %>

      <% if summary.prepare_log.to_s.strip != "" %>
        <details>
          <summary><strong>Prepare Log</strong></summary>
          <pre><%= summary.prepare_log %></pre>
        </details>
      <% end %>

      <!-- -------------------------------------------------------------- -->
      <!-- VERIFY DETAILS -->
      <!-- -------------------------------------------------------------- -->
      <h2>Verify Phase</h2>

      <% if summary.verify_ok? %>
        <span class="badge green">Verify OK</span>
      <% else %>
        <span class="badge red">Verify Failed</span>
      <% end %>

      <% if summary.verify_errors.any? %>
        <details open>
          <summary><strong>Errors</strong></summary>
          <ul>
            <% summary.verify_errors.each do |err| %>
              <li>‚ùå <%= err %></li>
            <% end %>
          </ul>
        </details>
      <% end %>

      <% if summary.verify_log.to_s.strip != "" %>
        <details>
          <summary><strong>Verify Log</strong></summary>
          <pre><%= summary.verify_log %></pre>
        </details>
      <% end %>

      <footer>
        panda-assets-verify-action v1 ¬∑ Generated automatically
      </footer>
    </div>
  </body>
</html>
